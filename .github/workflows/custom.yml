name: Build and Deploy GitBook

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js 10
        uses: actions/setup-node@v3
        with:
          node-version: '10.x'  # GitBook CLI requires Node 10

      - name: Install GitBook and dependencies
        run: |
          npm install -g gitbook-cli
          gitbook fetch 3.2.3
          npm install replace-in-file@5.0.2 --save-dev  # Older version compatible with Node 10
          npm install @fortawesome/fontawesome-free@5.15.4 --save-dev  # Version compatible with Node 10

      - name: Set up FontAwesome
        run: |
          mkdir -p .gitbook/styles
          cp node_modules/@fortawesome/fontawesome-free/css/all.min.css .gitbook/styles/
          echo '@import "styles/all.min.css";' > .gitbook/website.css
          echo 'i.fas { margin-right: 5px; }' >> .gitbook/website.css

      - name: Replace icon patterns
        run: |
          npx replace-in-file \
            --files="**/*.md" \
            --from='icon:([a-z-]+)' \
            --to='<i class="fas fa-$1"></i>'
          
          npx replace-in-file \
            --files="**/*.md" \
            --from='icon-projector' \
            --to='<i class="fas fa-projector"></i>'

      - name: Configure GitBook
        run: |
          cat << 'EOF' > book.json
          {
            "plugins": ["hints"],
            "pluginsConfig": {
              "hints": {
                "info": "ℹ️",
                "warning": "⚠️",
                "danger": "❌"
              }
            },
            "styles": {
              "website": "styles/website.css"
            }
          }
          EOF

      - name: Build GitBook
        run: |
          gitbook install
          gitbook build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_book
